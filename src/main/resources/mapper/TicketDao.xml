<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="com.westernstory.api.dao.TicketDao">
	<!--<cache eviction="FIFO" flushInterval="10000" size="512" readOnly="true" />-->

	<select id="list" resultType="TicketModel">
		SELECT id, name, thumbnail, total, address, startTime, endTime, createTime, summary
		FROM Ticket
		WHERE isActive = 1
		  <![CDATA[
            AND endTime  > (select UNIX_TIMESTAMP(NOW()) * 1000)
		  ]]>
        <if test="keyword != null and keyword != ''">
            AND (`Name` LIKE "%"#{keyword}"%" OR Summary LIKE "%"#{keyword}"%")
        </if>
		ORDER BY startTime DESC
		Limit #{start}, #{limit}
	</select>

    <select id="count" resultType="long">
        SELECT count(1)
        FROM Ticket
        WHERE isActive = 1
        <![CDATA[
            AND endTime  > (select UNIX_TIMESTAMP(NOW()) * 1000)
		  ]]>
        <if test="keyword != null and keyword != ''">
            AND (`Name` LIKE "%"#{keyword}"%" OR Summary LIKE "%"#{keyword}"%")
        </if>
    </select>

    <select id="getMyList" resultType="TicketModel">
        SELECT t1.id, t1.TicketId, t1.createTime,
          t2.name, t2.thumbnail, t2.total, t2.address, t2.startTime, t2.endTime, t2.summary
        FROM UserTicket t1
        LEFT JOIN Ticket t2 ON t2.id = t1.ticketId
        WHERE t2.isActive = 1 AND t1.isActive = 1 AND t1.userId = #{userId}
        ORDER BY t1.createTime DESC
        Limit #{start}, #{limit}
    </select>

    <select id="countByUser" resultType="long">
        SELECT count(1)
        FROM UserTicket t1
        LEFT JOIN Ticket t2 ON t2.id = t1.ticketId
        WHERE t2.isActive = 1 AND t1.isActive = 1 AND t1.userId = #{userId}
    </select>

    <insert id="gain">
      INSERT INTO UserTicket (
        UserId, TicketId, Total, IsUsed, IsActive, CreateTime, UpdateTime
      ) VALUE (
        #{userId}, #{ticketId}, 1, 0, 1, (select UNIX_TIMESTAMP(NOW()) * 1000), (select UNIX_TIMESTAMP(NOW()) * 1000)
      )
    </insert>

    <select id="getCount" resultType="int">
        SELECT count(id)
        FROM UserTicket
        WHERE isActive = 1 AND ticketId = #{id}
    </select>

    <select id="getById" resultType="TicketModel">
        SELECT id, name, thumbnail, total, address, startTime, endTime, createTime, summary
        FROM Ticket
        WHERE isActive = 1 AND id = #{id}
        Limit 1
    </select>

    <select id="getUserTicket" resultType="UserTicketModel">
        SELECT id, ticketId, userId
        FROM UserTicket
        WHERE isActive = 1 AND ticketId = #{ticketId} AND userId = #{userId}
        Limit 1
    </select>

    <select id="countUnusedTickets" resultType="int">
        SELECT count(1)
        FROM UserTicket t1
        LEFT JOIN Ticket t2 ON t2.id = t1.ticketId
        WHERE t1.isActive = 1 AND t2.isActive = 1 AND t1.userId = #{userId}
        AND t1.isUsed = 0 AND <![CDATA[
              t2.endTime  > (select UNIX_TIMESTAMP(NOW()) * 1000)
		  ]]>
    </select>
</mapper>